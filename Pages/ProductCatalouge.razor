@page "/product-catalogue"
@attribute [Authorize(Roles = "Customer")]

@using PickupExpressApp.Client.Models
@using PickupExpressApp.Client.Services
@inject IProductService ProductService
@inject CartService CartService
@inject NavigationManager Navigation

<h3 class="mb-4">Available Products</h3>

<div class="mb-3">
    <button class="btn btn-outline-secondary" @onclick="GoToCart">
        Go to Cart
    </button>
</div>

@if (isLoading)
{
    <p>Loading products...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (products.Count == 0)
{
    <p>No products are currently available.</p>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var product in products)
        {
            <div class="col">
                <div class="card shadow-sm p-3">
                    <h5 class="card-title">@product.Name</h5>

                    <p class="card-text">
                        <strong>Price:</strong> @product.Price.ToString("C")<br/>
                        <strong>In Stock:</strong> @product.QuantityInStock<br/>
                        <strong>Description:</strong> @product.Description
                    </p>

                    @*If Item has been added to the cart in the past 1.5 seconds, give visual feedback*@
                    @if (addedToCartTracker.ContainsKey(product) && addedToCartTracker[product])
                    {
                        
                        <div class="mb-3">
                            <button class="btn btn-success w-100" disabled>
                                Added!
                            </button>
                        </div>
                    }
                    @*If not, button remains as is*@
                    else if (@product.QuantityInStock <= 0)
                    {
                        <div class="mb-3">
                            <button class="btn btn-secondary w-100" disabled>
                                Add to Order
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <button class="btn btn-primary w-100" @onclick="() => AddToCart(product)">
                                Add to Order
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Product> products = new();
    private bool isLoading = true;
    private string? error;
    private Dictionary<Product, bool> addedToCartTracker = new Dictionary<Product, bool>();

    protected override async Task OnInitializedAsync()
    {
        await LoadCatalogue();
    }

    private async Task LoadCatalogue()
    {
        try
        {
            isLoading = true;
            products = await ProductService.GetAllProductsAsync();
        }
        catch (Exception e)
        {
            error = "Failed to load products: " + e.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task AddToCart(Product product)
    {
        await CartService.AddToCartAsync(product.ProductId);
        addedToCartTracker[product] = true;
        StateHasChanged();

        await Task.Delay(1500);
        addedToCartTracker[product] = false;
        StateHasChanged();
    }

    private void GoToCart()
    {
        Navigation.NavigateTo("/cart");
    }
}