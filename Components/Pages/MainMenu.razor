@page "/mainmenu"
@attribute [Authorize]
@inject AuthenticationStateProvider AuthProvider
@using System.Security.Claims
@using PickupExpressApp.Client.Models

<h3>Main Menu</h3>

@if (user == null)
{
    <p>Loading...</p>
}
else
{
    var role = GetUserRole(user!);

    @if (role == UserRole.Employee)
    {
        <EmployeeDashboard />
    }
    else if (role == UserRole.Customer)
    {
        <CustomerDashboard />
    }
    else
    {
        <p>Unknown role â€” please contact support.</p>
    }
}

@code {
    private ClaimsPrincipal? user;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        user = authState.User;

        // Debug: dump all claims to console
        foreach (var claim in user.Claims)
        {
            Console.WriteLine($"{claim.Type} = {claim.Value}");
        }
    }

    private UserRole? GetUserRole(ClaimsPrincipal user)
    {
        string? roleClaim = user.FindFirst(ClaimTypes.Role)?.Value 
                            ?? user.FindFirst("role")?.Value;

        if (!string.IsNullOrWhiteSpace(roleClaim) &&
            Enum.TryParse<UserRole>(roleClaim, ignoreCase: true, out UserRole role))
        {
            Console.WriteLine("Parsed UserRole: " + role);
            return role;
        }

        Console.WriteLine("User role not found or invalid.");
        return null;
    }
}